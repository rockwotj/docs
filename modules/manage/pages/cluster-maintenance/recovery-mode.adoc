= Recovery Mode
:description: 

Recovery mode allows you to start Redpanda and form a stable cluster when a cluster fails due to a system crash, OOM errors, or other issues that make a normal startup infeasible. 

In recovery mode, cluster configuration changes and other administrative actions are permitted so you can repair and recover the failed cluster. Communication between producers and consumers, as well as topic reads and writes, are disabled.

== Prerequisites

Recovery mode can only be entered during initial cluster formation as brokers start up and not while they are already running.

== Use recovery mode

////

1. Entering/exiting Recovery mode
2. Using the enable/disable partitions API or RPK commands (API detailed here, the RPK in the PRD).

////

To use recovery mode, first configure the node property to enable recovery mode when a broker starts. Once enabled, you can also disable partitions, if the cluster failure is localized to just a few partitions.

=== Enable recovery mode

. Run the `rpk redpanda mode` command to set the `recovery_mode_enabled` broker configuration property to `true`.
// TODO: confirm whether rpk command is available
// TODO: required flags
+
[,bash] 
---- 
rpk 
----
+
. Start the cluster. You can run `rpk cluster health` to check whether the cluster has entered recovery mode.

All brokers in the cluster must enter recovery mode together. If a cluster starts and a broker that doesn't have recovery mode enabled attempts to join, the broker will exit and return an error.

All private Redpanda topics such as `__consumer_offsets` are accessible. While data in user-created topics is not available, you can manage the topics metadata.

You can perform the following operations in recovery mode:
* Edit controller metadata
** Edit cluster configurations
** Enable and disable features
** Add and remove users and ACLs
** Add new brokers to the cluster
** Modify topic properties
** Delete topics
** Delete WASM transforms
* Edit consumer group metadata

Node-wide and cluster-wide processes are disabled as they may disrupt recovery operations:
* Partition and leader balancers
* Tiered storage object storage housekeeping
* Tiered storage cache management
* Compaction

You can use the Admin API when the cluster is in recovery mode. The HTTP Proxy and Schema Registry APIs are not available.

=== Disable partitions

If a specific partition caused the cluster to fail or is interfering with cluster recovery, you can manage the partition using the Admin API.

The examples below assume that the Admin API port is `8081`.

==== Disable a specific partition of a topic

// TODO: Confirm whether these are new API endpoints and that they are available
[tabs]
====
Curl::
+
--
curl -X POST -d '{"disabled": true}' http://localhost:8081/cluster/partitions/kafka/<topic_name>/<partition_id>
--
rpk::
+
--
rpk cluster partitions disable --topic <topic_name> --partition <partition_id>
--
====

==== Enable a specific partition of a topic

[tabs]
====
Curl::
+
--
curl -X POST -d '{"disabled": false}' http://localhost:8081/cluster/partitions/kafka/<topic_name>/<partition_id>
--
rpk::
+
--
rpk cluster partitions enable --topic <topic_name> --partition <partition_id>
--
====

==== Disable all partitions of a specific topic

[tabs]
====
Curl::
+
--
curl -X POST -d '{"disabled": true}' http://localhost:8081/cluster/partitions/kafka/<topic>
--
rpk::
+
--
rpk cluster partitions disable --topic <topic>
--
====

==== Enable all partitions of a specific topic

[tabs]
====
Curl::
+
--
curl -X POST -d '{"disabled": false}' http://localhost:8081/cluster/partitions/kafka/<topic>
--
rpk::
+
--
rpk cluster partitions enable --topic <topic>
--
====

== About

////

recovery Mode permits cluster config changes and other administrative actions (e.g. deactivating partitions, deleting topics, user/acl changes, deleting consumer groups, deleting stuck transactions, deleting wasm transforms, etc) to repair a nonfunctional cluster. 

////

Some, but not all, unrecoverable situations could be remedied through manual administrative actions taken while the cluster is running without traffic and without data being available to clients, in particular when the data and/or traffic itself are what prevent a successful start.

recovery mode intends to avoid triggering a storm of partition leader elections and replication (e.g. heavy learner replica recovery load after a long broker downtime) that typically occurs on startup (especially after downtime). 

Recovery mode also intends to avoid the load of Kafka API/HTTP Proxy connections, because normal traffic and especially abusive/rogue traffic can prevent availability for all users, even the admin trying to resuscitate the cluster.





=== Disable partition


Data partitions are not accessible in recovery mode, because no initialization, leader election or replication should occur on any data partition. and as such no ‘data plane’ actions can be taken in this mode.
The data balancer/leader balancer, and any other subsystems relying on data partitions should be completely disabled when in recovery mode
As the problems preventing startup are often isolated to certain partitions/topics, recovery mode should allow partition ‘deactivation’ at a single partition or at the topic level.  After deactivation, exiting recovery mode and starting redpanda without recovery mode should leave these partitions in a deactivated state (not ‘created’ in the running cluster), but activate all other partitions as normal.  Deactivated partitions/topics should appear as Replica Not Available”’ with respect to Kafka API requests. The data balancer should ignore deactivated partitions

== Troubleshooting

A user should be able to list currently deactivated partitions/topics via RPK using ‘rpk cluster partitions’






